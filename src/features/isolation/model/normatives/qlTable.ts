import {
  interpolate2DDecimal,
  type BilinearInterpolationResult,
  type Table2D,
} from "@/shared/model/calcualteBilinearInterpolation";
import { type DecimalType } from "@/lib/decimal";
import {
  LAYING_CONDITION,
  WORKING_HOURS_PER_YEAR,
  type LayingCondition,
  type WorkingHoursPerYear,
} from "../calcModes";

const OUTDOOR_PLACEMENT: LayingCondition = LAYING_CONDITION.OUTDOOR;

const isOutdoorPlacement = (layingCondition: LayingCondition): boolean => {
  return layingCondition === OUTDOOR_PLACEMENT;
};

type PlacementByGroup = { outdoor: Table2D; indoor: Table2D };

const AXES = {
  x: [20, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600], // tAvg
  y: [
    15, 20, 25, 40, 50, 65, 80, 100, 125, 150, 200, 250, 300, 350, 400, 450,
    500, 600, 700, 800, 900, 1000, 1400,
  ], // pipe_diameter
} as const;

const QL_BY_PLACEMENT_AND_WORKING_HOURS: Record<
  WorkingHoursPerYear,
  PlacementByGroup
> = {
  [WORKING_HOURS_PER_YEAR.LESS_OR_EQUAL_5000]: {
    outdoor: {
      x: [...AXES.x],
      y: [...AXES.y],
      values: [
        [4, 10, 18, 28, 38, 49, 61, 74, 87, 102, 117, 133, 150],
        [5, 11, 21, 31, 42, 54, 67, 81, 96, 112, 128, 146, 164],
        [5, 12, 23, 34, 46, 59, 73, 88, 104, 120, 138, 157, 176],
        [6, 14, 26, 39, 52, 67, 82, 99, 116, 135, 154, 174, 196],
        [7, 16, 29, 43, 57, 73, 90, 107, 126, 146, 167, 189, 212],
        [8, 18, 33, 48, 65, 82, 100, 120, 141, 162, 185, 209, 234],
        [9, 20, 36, 52, 69, 88, 107, 128, 150, 172, 197, 222, 248],
        [10, 22, 39, 57, 76, 96, 116, 139, 162, 187, 212, 239, 267],
        [12, 25, 44, 63, 84, 113, 137, 162, 189, 216, 245, 276, 307],
        [13, 27, 48, 70, 92, 123, 149, 176, 205, 235, 266, 298, 332],
        [16, 34, 59, 83, 109, 146, 176, 207, 240, 274, 310, 347, 385],
        [19, 39, 67, 95, 124, 166, 199, 234, 270, 307, 346, 387, 429],
        [22, 44, 76, 106, 138, 184, 220, 258, 297, 338, 380, 424, 469],
        [27, 54, 92, 128, 164, 202, 241, 282, 324, 368, 413, 460, 508],
        [30, 60, 100, 139, 178, 219, 260, 304, 349, 395, 443, 493, 544],
        [33, 65, 109, 150, 192, 235, 280, 326, 373, 422, 473, 526, 580],
        [36, 71, 118, 162, 207, 253, 300, 349, 399, 451, 505, 561, 618],
        [42, 82, 135, 185, 235, 285, 338, 391, 447, 504, 563, 624, 686],
        [47, 91, 150, 204, 259, 314, 371, 429, 489, 551, 614, 679, 746],
        [53, 102, 166, 226, 286, 346, 407, 470, 535, 602, 670, 740, 812],
        [59, 112, 183, 248, 312, 377, 443, 511, 581, 652, 725, 800, 877],
        [64, 123, 199, 269, 339, 408, 479, 552, 626, 702, 780, 860, 941],
        [87, 165, 264, 355, 444, 532, 621, 712, 804, 898, 995, 1092, 1193],
      ],
    },
    indoor: {
      x: AXES.x.slice(1),
      y: [...AXES.y],
      values: [
        [6, 16, 25, 35, 46, 58, 71, 85, 99, 114, 130, 147],
        [7, 18, 28, 40, 52, 65, 79, 93, 109, 126, 143, 161],
        [8, 20, 31, 43, 56, 70, 85, 101, 118, 136, 154, 174],
        [10, 23, 36, 49, 64, 80, 96, 114, 132, 152, 172, 194],
        [11, 25, 40, 54, 70, 87, 105, 124, 144, 165, 187, 210],
        [13, 29, 45, 62, 79, 98, 118, 139, 161, 184, 208, 233],
        [14, 32, 49, 66, 85, 105, 126, 148, 171, 195, 221, 247],
        [16, 35, 54, 73, 93, 115, 137, 161, 186, 212, 239, 267],
        [18, 39, 60, 81, 103, 126, 151, 176, 203, 231, 261, 291],
        [21, 44, 66, 89, 113, 138, 164, 192, 221, 251, 282, 315],
        [26, 53, 80, 107, 134, 163, 194, 225, 258, 292, 328, 365],
        [30, 62, 92, 122, 153, 185, 218, 253, 290, 327, 366, 407],
        [34, 70, 103, 136, 170, 205, 241, 279, 319, 359, 402, 446],
        [38, 77, 113, 149, 186, 224, 263, 304, 347, 391, 436, 483],
        [42, 85, 123, 162, 201, 242, 284, 328, 373, 419, 467, 517],
        [46, 92, 134, 175, 217, 260, 305, 351, 398, 448, 498, 551],
        [51, 100, 144, 189, 233, 279, 327, 375, 426, 478, 532, 587],
        [58, 114, 164, 214, 263, 314, 367, 420, 476, 533, 592, 652],
        [65, 127, 182, 236, 290, 345, 402, 460, 520, 582, 645, 710],
        [73, 141, 202, 261, 320, 379, 441, 504, 568, 635, 703, 772],
        [81, 156, 221, 285, 349, 413, 479, 547, 616, 687, 760, 834],
        [89, 170, 241, 309, 378, 447, 518, 590, 663, 739, 816, 896],
        [120, 226, 318, 406, 492, 580, 668, 758, 850, 943, 1038, 1136],
      ],
    },
  },
  [WORKING_HOURS_PER_YEAR.MORE_THAN_5000]: {
    outdoor: {
      x: [...AXES.x],
      y: [...AXES.y],
      values: [
        [4, 9, 17, 25, 35, 45, 56, 68, 81, 94, 109, 124, 140],
        [4, 10, 19, 28, 39, 50, 62, 75, 89, 103, 119, 135, 152],
        [5, 11, 20, 31, 42, 54, 67, 81, 95, 111, 128, 145, 163],
        [5, 12, 23, 35, 47, 60, 75, 90, 106, 123, 142, 161, 181],
        [6, 14, 26, 38, 51, 66, 81, 98, 115, 133, 153, 173, 195],
        [7, 16, 29, 43, 58, 74, 90, 108, 127, 147, 169, 191, 214],
        [8, 17, 31, 46, 62, 78, 96, 115, 135, 156, 179, 202, 226],
        [9, 19, 34, 50, 67, 85, 104, 124, 146, 168, 192, 217, 243],
        [10, 21, 38, 55, 74, 93, 114, 136, 159, 183, 208, 235, 263],
        [11, 23, 42, 61, 80, 101, 132, 156, 182, 209, 238, 267],
        [14, 28, 50, 72, 95, 119, 154, 182, 212, 242, 274, 308, 343],
        [16, 33, 57, 82, 107, 133, 173, 204, 236, 270, 305, 342, 380],
        [18, 37, 64, 91, 118, 147, 191, 224, 259, 296, 333, 373, 414],
        [22, 45, 77, 108, 140, 173, 208, 244, 281, 320, 361, 403, 446],
        [25, 49, 84, 117, 152, 187, 223, 262, 301, 343, 385, 430, 476],
        [27, 54, 91, 127, 163, 200, 239, 280, 322, 365, 410, 457, 505],
        [30, 58, 98, 136, 175, 215, 256, 299, 343, 389, 436, 486, 537],
        [34, 67, 112, 154, 197, 241, 286, 333, 382, 432, 484, 537, 593],
        [38, 75, 124, 170, 217, 264, 313, 364, 416, 470, 526, 583, 642],
        [43, 83, 137, 188, 238, 290, 343, 397, 453, 511, 571, 633, 696],
        [47, 91, 150, 205, 259, 315, 372, 430, 490, 552, 616, 681, 749],
        [52, 100, 163, 222, 281, 340, 400, 463, 527, 592, 660, 729, 801],
        [70, 133, 215, 291, 364, 439, 514, 591, 670, 750, 833, 918, 1098],
      ],
    },
    indoor: {
      x: AXES.x.slice(1),
      y: [...AXES.y],
      values: [
        [6, 14, 23, 33, 43, 54, 66, 79, 93, 107, 122, 138],
        [7, 16, 26, 37, 48, 60, 73, 87, 102, 117, 134, 151],
        [8, 18, 28, 40, 52, 65, 79, 94, 110, 126, 144, 162],
        [9, 21, 32, 45, 59, 73, 89, 105, 122, 141, 160, 180],
        [10, 23, 36, 50, 64, 80, 96, 114, 133, 152, 173, 194],
        [12, 26, 41, 56, 72, 89, 107, 127, 147, 169, 191, 214],
        [13, 28, 44, 60, 77, 95, 114, 135, 156, 179, 202, 227],
        [14, 31, 48, 65, 84, 103, 124, 146, 169, 193, 218, 244],
        [16, 35, 53, 72, 92, 113, 136, 159, 184, 210, 237, 265],
        [18, 38, 58, 79, 100, 123, 147, 172, 199, 226, 255, 285],
        [22, 46, 70, 93, 118, 144, 172, 200, 230, 262, 294, 328],
        [26, 53, 79, 106, 134, 162, 193, 224, 257, 291, 327, 364],
        [29, 60, 88, 118, 148, 179, 212, 246, 281, 318, 357, 396],
        [33, 66, 97, 129, 161, 195, 230, 267, 305, 344, 385, 428],
        [36, 72, 106, 139, 174, 210, 247, 286, 326, 368, 411, 456],
        [39, 78, 114, 150, 187, 225, 264, 305, 348, 392, 437, 484],
        [43, 84, 123, 161, 200, 241, 282, 326, 370, 417, 465, 514],
        [49, 96, 139, 181, 225, 269, 315, 363, 412, 462, 515, 569],
        [55, 107, 153, 200, 247, 295, 344, 395, 448, 502, 558, 616],
        [61, 118, 169, 220, 270, 322, 376, 431, 487, 546, 606, 668],
        [67, 130, 185, 239, 294, 350, 407, 466, 527, 589, 653, 718],
        [74, 141, 201, 259, 318, 377, 438, 501, 565, 631, 699, 768],
        [99, 187, 263, 337, 411, 485, 561, 638, 716, 797, 880, 964],
      ],
    },
  },
};

export function getQl(
  pipe_diameter: number | null,
  tAvg: DecimalType | null,
  layingCondition: LayingCondition,
  workingHoursPerYear: WorkingHoursPerYear
): BilinearInterpolationResult | null {
  if (!pipe_diameter || !tAvg) {
    return null;
  }
  const placement = isOutdoorPlacement(layingCondition) ? "outdoor" : "indoor";
  const table =
    QL_BY_PLACEMENT_AND_WORKING_HOURS[workingHoursPerYear][placement];
  return interpolate2DDecimal(table, tAvg, pipe_diameter);
}
